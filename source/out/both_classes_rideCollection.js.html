<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: both/classes/rideCollection.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: both/classes/rideCollection.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @summary Create a collection of rides in the MongoDB
 * @locus Anywhere
 * @type {Meteor.Collection}
 */
// Create Ride MongoDB collection
Rides = new Meteor.Collection("rides", {
  transform: function(doc) {
    return new Ride(doc._id, doc.user, doc.group, doc.pickupLoc, doc.destLoc, doc.createdAt);
  }
});

/**
 * @summary Represents a ride.
 * @param id
 * @param user
 * @param group
 * @param pickupLoc
 * @param destLoc
 * @param createdAt
 * @constructor
 */
// A Ride class that takes a document in its constructor
Ride = function (id, user, group, pickupLoc, destLoc, createdAt) {
  this._id = id;
  if (!user) {
    user = Meteor.userId();
  }
  if (!group) {
    group = Meteor.user().getGroup().id;
  }
  this._user = user;
  this._group = group;
  this._pickupLoc = pickupLoc;
  this._destLoc = destLoc;
  this._createdAt = createdAt;
};

/**
 * @summary The methods for the ride class.
 * @locus Anywhere
 */
Ride.prototype = {
  get id() {
    // readonly
    return this._id;
  },
  get user() {
    // readonly
    return this._user;
  },
  get group() {
    // readonly
    return this._group;
  },
  get pickupLoc() {
    // readonly
    return this._pickupLoc;
  },
  get destLoc() {
    return this._destLoc;
  },
  get createdAt() {
    return this._createdAt;
  },
  set pickupLoc(value) {
    this._pickupLoc = value;
  },
  set destLoc(value) {
    this._destLoc = value;
  },

  /**
   * @summary Saving functionality for the ride instance.
   * @param callback
   * @function
   */
  save: function(callback) {
    if (!this.user) {
      throw new Meteor.Error("User is not defined!");
    }

    if (Rides.findOne({user: this.user})) {
      throw new Meteor.Error("User has already requested a ride!");
    }

    if (!this.pickupLoc) {
      throw new Meteor.Error("Pickup location is not defined!");
    }

    if (!this.destLoc) {
      throw new Meteor.Error("Destination location is not defined!");
    }

    var doc = {
      pickupLoc: this.pickupLoc,
      destLoc: this.destLoc
    };

    // If this ride already exists, then modify it.
    if (this.id) {
      Rides.update(this.id, {$set: doc}, callback);
      // Else, create a new ride.
    } else {
      doc.user = this.user;
      doc.group = this.group;
      doc.createdAt = Date.now();
      console.log(doc.createdAt);

      // remember the context, since in callback it's changed
      var that = this;
      Rides.insert(doc , function (error , result) {
        that._id = result;

        if(callback != null) {
          callback.call(that , error , result);
        }
      });
    }
  },

  /**
   * @summary Delete functionality for the ride instance.
   * @param callback
   * @function
   */
  delete: function(callback) {
    Rides.remove(this.id, callback);
  },

  /**
   * @summary Cancel a ride that has been requested.
   * @param callback
   * @function
   */
  cancel: function(callback) {
    if (!this.group) {
      throw new Meteor.Error("group not defined!");
    }
    var that  = this;
    console.log(Groups.findOne(this.group));
    Groups.findOne(this.group).removeRideFromQueue(this.id, function(err, res) {
      if (err) {
        throw err;
      }
      that.delete(callback);
    });

  }
};


if(Meteor.isServer) {

  Rides.allow({
    // Drivers cannot ask for rides.
    'insert' : function (userId , doc) {
      return !Users.findOne(userId).isDriver() &amp;&amp; doc.user === userId;
    } ,
    'update' : function (userId , doc) {
      return doc.user === userId;
    },
    'remove' : function (userId , doc) {
      return doc.user === userId;
    }
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Driver.html">Driver</a></li><li><a href="Group.html">Group</a></li><li><a href="Ride.html">Ride</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Drivers">Drivers</a></li><li><a href="global.html#Groups">Groups</a></li><li><a href="global.html#isValidEmail">isValidEmail</a></li><li><a href="global.html#Rides">Rides</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Mon Apr 27 2015 18:25:07 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
