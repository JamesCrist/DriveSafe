<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: both/classes/userCollection.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: both/classes/userCollection.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>Meteor.users._transform = function (doc) {
  var newInstance = new User();

  return _.extend(newInstance , doc);
};

/**
 * @summary Represents a user.
 * @locus Anywhere
 * @constructor
 */
User = function () {
};

/**
 * @summary The methods for the user class.
 * @locus Anywhere
 */
User.prototype = {
  getName : function () {
    return this.profile.name;
  } ,
  getId : function () {
    return this._id;
  } ,
  getGroup: function() {
    return Groups.findOne(this.profile.group);
  },
  isAdmin : function () {
    return this.profile.isAdmin;
  } ,
  isDriver : function () {
    return this.profile.isDriver;
  } ,
  setIsDriver : function (isDriver) {
    this.profile.isDriver = true;
    Users.update(this.getId() , { $set : { 'profile.isDriver' : isDriver } });
  } ,
  setIsAdmin : function (isAdmin) {
    this.profile.isAdmin = isAdmin;
    Users.update(this.getId() , { $set : { 'profile.isAdmin' : isAdmin } });
  } ,
  setGroup : function (newGroupId) {
    this.profile.group = newGroupId;
    Users.update(this.getId() , { $set : { 'profile.group' : newGroupId } });
  } ,

  /**
   * @summary Remove user from current group.
   * @param callback
   * @function
   */
  leaveGroup : function (callback) {
    // Call the group's remove member function
    var that = this;
    // If user does not have a group already, then just update the user in the database.
    if (!this.getGroup()) {
      Users.update(that._id, {$set: {'profile.group': null, 'profile.isAdmin': false, 'profile.isDriver': false}}, callback);
      return;
    }
    this.getGroup().removeMember(this.getId(), function(err, res) {
      if (err &amp;&amp; callback) {
        callback.call(that, err, res);
      } else {
        // No error, so update this user's current group.
        that.setGroup(null);
        that.setIsAdmin(false);
        that.setIsDriver(false);
      }
    });
  } ,

  /**
   * @summary Create a new group and become the admin of that group.
   * @param newGroupName
   * @param newGroupKey
   * @param callback
   * @function
   */
  createGroup : function (newGroupName , newGroupKey , callback) {
    // Create a new group object
    var newGroup = new Group(null, newGroupName, null, null, null, null, newGroupKey);
    var that = this;
    newGroup.save(function(err, groupId) {
      if (!err) {
        that.setGroup(groupId);
        that.setIsAdmin(true);
      }
      callback.call(that, err, groupId);
    });
  } ,

  /**
   * @summary Join an already existing group using the group name and key.
   * @param groupName
   * @param groupKey
   * @param callback
   * @function
   */
  joinGroup : function (groupName , groupKey , callback) {
    if (this.getGroup()) {
      throw new Meteor.Error("User is already in group! Leave current group first");
    }
    // Call the server side function to add the current user to a group.
    // This is done server side to improve efficiency and security.
    Meteor.call("joinGroup" , groupName , groupKey , function (err, res) {
      if(!err) {
        console.log(res);
        this.setGroup(res);
      }
      callback(err);
    }.bind(this));
  } ,

  /**
   * @summary Become admin of current group.
   * @param callback
   * @function
   */
  becomeAdmin: function (callback) {
    var oldAdmin = Users.findOne(this.getGroup().admin);
    var that = this;
    this.getGroup().changeAdmin(this, function(err, res) {
      if (!err) {
        oldAdmin.setIsAdmin(false);
        that.setIsAdmin(true);
      }
      callback.call(that, err, res);
    })
  } ,

  /**
   * @summary Become driver of current group.
   * @param callback
   * @function
   */
  becomeDriver : function (callback) {
    if(!this.getGroup()) {
      var error = new Meteor.Error("User must be in a group to become a driver!");
      callback.call(this, error, null);
      return;
    }
    var that = this;
    this.getGroup().addDriver(this, function(err, res) {
      if (!err) {
        var driver = new Driver(null, null, null, null);
        driver.save(function(err, res) {
          if (!err) {
            that.setIsDriver(true);
          }
          callback.call(that, err, res);
        });
      } else {
        console.log(err.message);
        callback.call(that , err , res);
      }
    });
  } ,

  /**
   * @summary Revoke driver status of user.
   * @param callback
   * @function
   */
  stopDriving : function (callback) {
    if(!this.getGroup()) {
      var error = new Meteor.Error("User's group could not be found!");
      callback.call(this, error, null);
      return;
    }
    var that = this;
    this.getGroup().removeDriver(this, function(err, res) {
      if (!err) {
        that.setIsDriver(false);
      }
      callback.call(that, err, res);
    });
  } ,

  /**
   * @summary Set location of user.
   * @param lat
   * @param lng
   * @function
   */
  updateLocation : function (lat , lng) {
    Users.update(this.getId() , {
      $set : {
        'profile.location' : {lat: lat, lng: lng}
      }
    });
  },

  /**
   * @function
   * @returns {number}
   */
  getLat : function() {
    return Users.findOne(this.getId()).profile.location.lat;
  },
  /**
   * @function
   * @returns {number}
   */
  getLng : function() {
    return Users.findOne(this.getId()).profile.location.lng;
  }
};

if(Meteor.isServer) {

  Users.allow({
    'insert': function (userId,doc) {
      return (userId === doc._id || Users.findOne(userId).isAdmin());
    },
    'update': function(userId, doc) {
      return (userId === doc._id || Users.findOne(userId).isAdmin());
    }
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Driver.html">Driver</a></li><li><a href="Group.html">Group</a></li><li><a href="Ride.html">Ride</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Drivers">Drivers</a></li><li><a href="global.html#Groups">Groups</a></li><li><a href="global.html#isValidEmail">isValidEmail</a></li><li><a href="global.html#Rides">Rides</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Mon Apr 27 2015 18:25:07 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
